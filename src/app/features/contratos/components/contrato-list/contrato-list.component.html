<div class="contratos-container">
  <div class="container-fluid">
    <!-- Header -->
    <div class="page-header">
      <div>
        <h1>
          <i class="bi bi-file-text-fill"></i>
          Gestión de Contratos
        </h1>
        <p class="page-subtitle">Administra los contratos de renting</p>
      </div>
      <button class="btn btn-primary" (click)="abrirModalCrear()">
        <i class="bi bi-plus-circle"></i>
        Nuevo Contrato
      </button>
    </div>

    <!-- Filtros -->
    <div class="filters-container">
      <div class="row g-3">
        <div class="col-md-6">
          <div class="search-box">
            <i class="bi bi-search"></i>
            <input
              type="text"
              class="form-control"
              placeholder="Buscar por matrícula o cliente..."
              [(ngModel)]="filtroTexto"
              (input)="aplicarFiltros()"
            />
          </div>
        </div>
        <div class="col-md-3">
          <select class="form-select" [(ngModel)]="filtroEstado" (change)="aplicarFiltros()">
            <option value="">Todos los estados</option>
            <option value="ACTIVO">Activo</option>
            <option value="FINALIZADO">Finalizado</option>
            <option value="CANCELADO">Cancelado</option>
          </select>
        </div>
        <div class="col-md-3">
          <button class="btn btn-outline-primary w-100" (click)="limpiarFiltros()">
            <i class="bi bi-x-circle"></i>
            Limpiar
          </button>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div *ngIf="loading" class="spinner-container">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
    </div>

    <!-- Tabla de Contratos -->
    <div *ngIf="!loading && contratosFiltrados.length > 0" class="table-container fade-in">
      <table class="table">
        <thead>
          <tr>
            <th>Vehículo</th>
            <th>Cliente</th>
            <th>Fecha Inicio</th>
            <th>Fecha Fin</th>
            <th>Cuota Mensual</th>
            <th>Día Cobro</th>
            <th>Estado</th>
            <th class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let contrato of contratosFiltrados">
            <td>
              <div>
                <strong class="text-primary">{{ contrato.vehiculoMatricula }}</strong>
                <br>
                <small class="text-muted">{{ contrato.vehiculoMarcaModelo }}</small>
              </div>
            </td>
            <td>
              <div>
                {{ contrato.clienteNombre }}
                <br>
                <small class="text-muted">{{ contrato.clienteDni }}</small>
              </div>
            </td>
            <td>{{ contrato.fechaInicio | date:'dd/MM/yyyy' }}</td>
            <td>{{ contrato.fechaFin | date:'dd/MM/yyyy' }}</td>
            <td>
              <strong>{{ contrato.cuotaMensual | number:'1.2-2' }} €</strong>
            </td>
            <td>
              <span class="badge badge-dia">Día {{ contrato.diaCobroCuota }}</span>
            </td>
            <td>
              <span class="badge" [ngClass]="obtenerClaseEstado(contrato.estadoNombre)">
                {{ contrato.estadoNombre }}
              </span>
            </td>
            <td>
              <div class="action-buttons justify-content-end">
                <button
                  class="btn btn-sm btn-outline-info"
                  (click)="verCuotas(contrato)"
                  title="Ver cuotas"
                >
                  <i class="bi bi-list-check"></i>
                </button>
                <button
                  class="btn btn-sm btn-outline-primary"
                  (click)="verDetalle(contrato)"
                  title="Ver detalle"
                >
                  <i class="bi bi-eye"></i>
                </button>
                <button
                  *ngIf="contrato.estadoNombre === 'ACTIVO'"
                  class="btn btn-sm btn-outline-warning"
                  (click)="abrirModalEditar(contrato)"
                  title="Editar"
                >
                  <i class="bi bi-pencil"></i>
                </button>
                <button
                  *ngIf="contrato.estadoNombre === 'ACTIVO'"
                  class="btn btn-sm btn-outline-success"
                  (click)="confirmarFinalizar(contrato)"
                  title="Finalizar"
                >
                  <i class="bi bi-check-circle"></i>
                </button>
                <button
                  class="btn btn-sm btn-outline-danger"
                  (click)="confirmarEliminar(contrato)"
                  title="Eliminar"
                >
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loading && contratosFiltrados.length === 0" class="empty-state">
      <i class="bi bi-file-text"></i>
      <h5>No hay contratos</h5>
      <p *ngIf="filtroTexto || filtroEstado">
        No se encontraron contratos con los filtros aplicados
      </p>
      <p *ngIf="!filtroTexto && !filtroEstado">
        Comienza creando tu primer contrato de renting
      </p>
      <button class="btn btn-primary" (click)="abrirModalCrear()">
        <i class="bi bi-plus-circle"></i>
        Crear Contrato
      </button>
    </div>
  </div>
</div>

<!-- Modal Crear/Editar -->
<app-contrato-form
  *ngIf="mostrarModal"
  [contrato]="contratoSeleccionado"
  [esEdicion]="esEdicion"
  (cerrar)="cerrarModal()"
  (guardado)="onContratoGuardado()"
></app-contrato-form>

<!-- Modal Cuotas -->
<app-cuotas-modal
  *ngIf="mostrarModalCuotas"
  [contrato]="contratoSeleccionado"
  (cerrar)="cerrarModalCuotas()"
></app-cuotas-modal>